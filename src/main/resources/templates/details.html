<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glenn - Application Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .uptime-card {
            transition: all 0.3s;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        }
        .uptime-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .uptime-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .history-item {
            border-left: 3px solid transparent;
            transition: background-color 0.2s;
        }
        .history-item:hover {
            background-color: #f8f9fa;
        }
        .history-item.up {
            border-left-color: #198754;
        }
        .history-item.down {
            border-left-color: #dc3545;
        }
        .no-data {
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <a href="/" class="navbar-brand">
            <i class="bi bi-shield-check"></i>
            Glenn - Health Monitor
        </a>
    </div>
</nav>

<div class="container mt-4" th:with="app=${app}, stats=${stats}">
    <!-- Header with navigation -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                    <li class="breadcrumb-item active" th:text="${app.name}">Application Name</li>
                </ol>
            </nav>
        </div>
        <div class="col text-end">
            <a th:href="@{/app-form(id=${app.id})}" class="btn btn-outline-primary me-2">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <form th:action="@{/app/{id}/toggle(id=${app.id})}" method="post" style="display: inline;">
                <button type="submit" class="btn"
                        th:classappend="${app.active} ? 'btn-outline-warning' : 'btn-outline-success'">
                    <i th:class="${app.active} ? 'bi-pause-circle' : 'bi-play-circle'"></i>
                    <span th:text="${app.active} ? 'Disable' : 'Enable'"></span>
                </button>
            </form>
            <button class="btn btn-outline-danger"
                    onclick="deleteApp([[${app.id}]], '[[${app.name}]]')">
                <i class="bi bi-trash"></i> Delete
            </button>
        </div>
    </div>

    <!-- Application Info Card -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-info-circle"></i>
                Application Information
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th width="150">Name:</th>
                            <td><strong th:text="${app.name}">App Name</strong></td>
                        </tr>
                        <tr>
                            <th>Category:</th>
                            <td>
                                <span class="badge bg-secondary" th:if="${app.category}" th:text="${app.category}">Category</span>
                                <span class="text-muted" th:unless="${app.category}">Not categorized</span>
                            </td>
                        </tr>
                        <tr>
                            <th>URL:</th>
                            <td>
                                <a th:href="${app.url}" target="_blank" class="text-decoration-none" th:text="${app.url}">https://example.com</a>
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th width="150">Status:</th>
                            <td>
                                <span class="badge" th:classappend="${app.active} ? 'bg-success' : 'bg-secondary'">
                                    <i th:class="${app.active} ? 'bi-check-circle' : 'bi-pause-circle'"></i>
                                    <span th:text="${app.active} ? 'Active' : 'Paused'"></span>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>Accepted Statuses:</th>
                            <td>
                                <span th:each="status : ${app.acceptedStatusesList}"
                                      class="badge bg-info me-1" th:text="${status}">200</span>
                            </td>
                        </tr>
                        <tr>
                            <th>Created:</th>
                            <td th:text="${app.createdAt != null ? #temporals.format(app.createdAt, 'dd MMM yyyy HH:mm') : 'Unknown'}">01 Jan 2025 12:00</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div th:if="${app.description}" class="mt-2 p-3 bg-light rounded">
                <i class="bi bi-quote text-muted"></i>
                <span th:text="${app.description}">Description here</span>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4" th:if="${stats.totalChecks > 0}">
        <div class="col-md-3">
            <div class="uptime-card">
                <h6 class="text-muted">Success Rate</h6>
                <div class="uptime-value" th:text="${stats.successRate + '%'}">99.5%</div>
                <div class="text-success">
                    <i class="bi bi-check-circle"></i> Last <span th:text="${stats.totalChecks}">30</span> checks
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="uptime-card">
                <h6 class="text-muted">Avg Response</h6>
                <div class="uptime-value" th:text="${stats.avgResponseTime}">120ms</div>
                <div class="text-info">
                    <i class="bi bi-clock"></i> Average time
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="uptime-card">
                <h6 class="text-muted">Last Status</h6>
                <div class="uptime-value" style="font-size: 1.8rem;"
                     th:text="${stats.lastStatus}"
                     th:classappend="${stats.lastStatus == 'UP' ? 'text-success' : 'text-danger'}">UP</div>
                <div class="text-muted">
                    <i class="bi bi-clock-history"></i> <span th:text="${stats.lastTime}">12:00:00</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="uptime-card">
                <h6 class="text-muted">Total Checks</h6>
                <div class="uptime-value" th:text="${stats.totalChecks}">2,847</div>
                <div class="text-muted">
                    <i class="bi bi-check-circle"></i> Since creation
                </div>
            </div>
        </div>
    </div>

    <!-- Message when no stats -->
    <div class="row mb-4" th:if="${stats.totalChecks == 0}">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                No statistics available yet. Statistics will appear after the first health checks.
            </div>
        </div>
    </div>

    <!-- Response Time Chart -->
    <div class="card mb-4" th:if="${stats.totalChecks > 0}">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-graph-up"></i>
                Response Time History (last 20 checks)
            </h5>
        </div>
        <div class="card-body">
            <canvas id="responseTimeChart" style="height: 300px; width: 100%;"></canvas>
        </div>
    </div>

    <!-- Status History -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-clock-history"></i>
                Status History (last 30 checks)
            </h5>
        </div>
        <div class="card-body">
            <div class="list-group" id="historyList">
                <div th:each="check : ${history}"
                     class="list-group-item history-item d-flex justify-content-between align-items-center"
                     th:classappend="${check.isUp} ? 'up' : 'down'">

                    <div class="d-flex align-items-center">
                        <span class="status-indicator"
                              th:classappend="${check.isUp} ? 'bg-success' : 'bg-danger'"></span>
                        <div>
                            <strong th:text="${check.isUp} ? 'UP' : 'DOWN'"></strong>
                            <span class="text-muted mx-2">·</span>
                            <span class="text-muted" th:text="${check.statusCode}">200</span>
                            <span class="text-muted mx-2">·</span>
                            <span th:text="${check.responseTime}">120ms</span>
                        </div>
                    </div>

                    <div>
                        <small class="text-muted"
                               th:text="${check.checkedAt != null ? #temporals.format(check.checkedAt, 'HH:mm:ss') : 'Unknown'}">
                            12:00:00
                        </small>
                        <span th:if="${check.errorMessage}"
                              class="badge bg-danger ms-2"
                              th:title="${check.errorMessage}">
                            <i class="bi bi-exclamation-triangle"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    function deleteApp(id, name) {
        if (confirm(`Are you sure you want to delete "${name}"? This action cannot be undone.`)) {
            fetch(`/app/${id}/delete`, { method: 'POST' })
                .then(() => window.location.href = '/');
        }
    }

    // Get chart data from stats
    document.addEventListener('DOMContentLoaded', function() {
        const stats = /*[[${stats}]]*/ null;

        if (stats && stats.chartChecks && stats.chartChecks.length > 0) {
            const chartChecks = stats.chartChecks.reverse(); // Plus ancien au plus récent

            // Extraire les temps de réponse
            const responseTimes = chartChecks.map(check => {
                if (check.responseTime) {
                    const match = check.responseTime.match(/(\d+)/);
                    if (match) {
                        const val = parseInt(match[1]);
                        return val > 5000 ? 5000 : val;
                    }
                }
                return 0;
            });

            // Créer les labels
            const labels = chartChecks.map(check => {
                if (check.checkedAt) {
                    const date = new Date(check.checkedAt);
                    return date.getHours().toString().padStart(2, '0') + ':' +
                           date.getMinutes().toString().padStart(2, '0');
                }
                return 'N/A';
            });

            // Créer le graphique
            const ctx = document.getElementById('responseTimeChart').getContext('2d');

            if (window.myChart) {
                window.myChart.destroy();
            }

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Response Time (ms)',
                        data: responseTimes,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: chartChecks.map(check => {
                            return check.isUp ? '#198754' : '#dc3545';
                        }),
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const check = chartChecks[context.dataIndex];
                                    return [
                                        `Response: ${context.raw}ms`,
                                        `Status: ${check.statusCode}`,
                                        `Health: ${check.isUp ? 'UP' : 'DOWN'}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5000,
                            title: { display: true, text: 'Response Time (ms)' }
                        }
                    }
                }
            });
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>