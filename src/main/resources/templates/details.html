<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Icônes pour différentes plateformes -->
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/ios/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/icons/favicon-48x48.png">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-touch-icon-76x76.png">

    <!-- Android Chrome Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/android-chrome-512x512.png">

    <!-- Manifest pour PWA -->
    <link rel="manifest" href="/manifest.json">

    <title>Glenn - Application Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .uptime-card {
            transition: all 0.3s;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        }
        .uptime-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .uptime-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .history-item {
            border-left: 3px solid transparent;
            transition: background-color 0.2s;
        }
        .history-item:hover {
            background-color: #f8f9fa;
        }
        .history-item.up {
            border-left-color: #198754;
        }
        .history-item.down {
            border-left-color: #dc3545;
        }
        .no-data {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .chart-container {
            margin-bottom: 20px;
        }
        .chart-card {
            height: 100%;
        }
        .chart-card .card-body {
            padding: 10px;
        }
        canvas {
            max-height: 180px;
            width: 100% !important;
        }
        .refresh-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
        }
        .refresh-spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <a href="/" class="navbar-brand">
            <i class="bi bi-shield-check"></i>
            Glenn - Health Monitor
        </a>
    </div>
</nav>

<!-- Refresh indicator -->
<div class="refresh-indicator" id="refreshIndicator">
    <i class="bi bi-arrow-repeat refresh-spinner" id="refreshSpinner" style="display: none;"></i>
    <span id="refreshStatus">Auto-refresh active</span>
</div>

<div class="container mt-4" th:with="app=${app}">
    <!-- Header with navigation -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                    <li class="breadcrumb-item active" th:text="${app.name}">Application Name</li>
                </ol>
            </nav>
        </div>
        <div class="col text-end">
            <a th:href="@{/app/edit/{id}(id=${app.id})}" class="btn btn-outline-primary me-2">
                <i class="bi bi-pencil"></i> Edit
            </a>

            <form th:action="@{/app/{id}/toggle(id=${app.id})}" method="post" style="display: inline;">
                <button type="submit" class="btn"
                        th:classappend="${app.active} ? 'btn-outline-warning' : 'btn-outline-success'">
                    <i th:class="${app.active} ? 'bi-pause-circle' : 'bi-play-circle'"></i>
                    <span th:text="${app.active} ? 'Disable' : 'Enable'"></span>
                </button>
            </form>

            <form th:action="@{/app/{id}/delete(id=${app.id})}" method="post" style="display: inline;"
                  th:data-app-name="${app.name}" onsubmit="return confirmDelete(this)">
                <button type="submit" class="btn btn-outline-danger">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </form>
        </div>
    </div>

    <!-- Application Info Card -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-info-circle"></i>
                Application Information
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th width="150">Name:</th>
                            <td><strong th:text="${app.name}">App Name</strong></td>
                        </tr>
                        <tr>
                            <th>Category:</th>
                            <td>
                                <span class="badge bg-secondary" th:if="${app.category}" th:text="${app.category}">Category</span>
                                <span class="text-muted" th:unless="${app.category}">Not categorized</span>
                            </td>
                        </tr>
                        <tr>
                            <th>URL:</th>
                            <td>
                                <a th:href="${app.url}" target="_blank" class="text-decoration-none" th:text="${app.url}">https://example.com</a>
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th width="150">Status:</th>
                            <td>
                                <span class="badge" th:classappend="${app.active} ? 'bg-success' : 'bg-secondary'">
                                    <i th:class="${app.active} ? 'bi-check-circle' : 'bi-pause-circle'"></i>
                                    <span th:text="${app.active} ? 'Active' : 'Paused'"></span>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>Accepted Statuses:</th>
                            <td>
                                <span th:each="status : ${app.acceptedStatusesList}"
                                      class="badge bg-info me-1" th:text="${status}">200</span>
                            </td>
                        </tr>
                        <tr>
                            <th>Created:</th>
                            <td th:text="${app.createdAt != null ? #temporals.format(app.createdAt, 'dd MMM yyyy HH:mm') : 'Unknown'}">01 Jan 2025 12:00</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div th:if="${app.description}" class="mt-2 p-3 bg-light rounded">
                <i class="bi bi-quote text-muted"></i>
                <span th:text="${app.description}">Description here</span>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4" th:if="${stats != null and stats.totalChecks > 0}" id="stats-cards">
        <div class="col-md-3">
            <div class="uptime-card">
                <h6 class="text-muted">Success Rate</h6>
                <div class="uptime-value" th:text="${stats.successRate + '%'}">99.5%</div>
                <div class="text-success">
                    <i class="bi bi-check-circle"></i> Last <span th:text="${stats.totalChecks}">30</span> checks
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="uptime-card">
                <h6 class="text-muted">Avg Response</h6>
                <div class="uptime-value" th:text="${stats.avgResponseTime}">120ms</div>
                <div class="text-info">
                    <i class="bi bi-clock"></i> Average time
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="uptime-card">
                <h6 class="text-muted">Last Status</h6>
                <div class="uptime-value" style="font-size: 1.8rem;"
                     th:text="${stats.lastStatus}"
                     th:classappend="${stats.lastStatus == 'UP' ? 'text-success' : 'text-danger'}">UP</div>
                <div class="text-muted">
                    <i class="bi bi-clock-history"></i> <span th:text="${stats.lastTime}">12:00:00</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="uptime-card">
                <h6 class="text-muted">Total Checks</h6>
                <div class="uptime-value" th:text="${stats.totalChecks}">2,847</div>
                <div class="text-muted">
                    <i class="bi bi-check-circle"></i> Since creation
                </div>
            </div>
        </div>
    </div>

    <!-- Message when no stats -->
    <div class="row mb-4" th:if="${stats == null or stats.totalChecks == 0}">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                No statistics available yet. Statistics will appear after the first health checks.
            </div>
        </div>
    </div>

    <!-- Multiple Response Time Charts -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-graph-up"></i>
                Response Time History
            </h5>
        </div>
        <div class="card-body">
            <!-- First row: 3 charts -->
            <div class="row">
                <div class="col-md-4 chart-container">
                    <div class="card chart-card">
                        <div class="card-header py-2">
                            <small><strong>Last 10 checks</strong></small>
                        </div>
                        <div class="card-body">
                            <canvas id="chartRecent"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 chart-container">
                    <div class="card chart-card">
                        <div class="card-header py-2">
                            <small><strong>Last Hour</strong></small>
                        </div>
                        <div class="card-body">
                            <canvas id="chartHour"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 chart-container">
                    <div class="card chart-card">
                        <div class="card-header py-2">
                            <small><strong>Last 24 Hours</strong></small>
                        </div>
                        <div class="card-body">
                            <canvas id="chartDay"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Second row: 3 charts -->
            <div class="row">
                <div class="col-md-4 chart-container">
                    <div class="card chart-card">
                        <div class="card-header py-2">
                            <small><strong>Last Week</strong></small>
                        </div>
                        <div class="card-body">
                            <canvas id="chartWeek"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 chart-container">
                    <div class="card chart-card">
                        <div class="card-header py-2">
                            <small><strong>Last Month</strong></small>
                        </div>
                        <div class="card-body">
                            <canvas id="chartMonth"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 chart-container">
                    <div class="card chart-card">
                        <div class="card-header py-2">
                            <small><strong>Last Year</strong></small>
                        </div>
                        <div class="card-body">
                            <canvas id="chartYear"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status History -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-clock-history"></i>
                Status History (last 10 checks)
            </h5>
        </div>
        <div class="card-body">
            <div class="list-group" id="historyList">
                <!-- Rempli par JavaScript -->
            </div>
            <div class="text-center text-muted mt-2 small" id="historyCount"></div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    function confirmDelete(form) {
        const appName = form.getAttribute('data-app-name');
        return confirm(`Are you sure you want to delete "${appName}"? This action cannot be undone.`);
    }

    // Chart instances for refresh
    const charts = {};
    let appId = /*[[${app.id}]]*/ null;

    function extractResponseTime(responseTime) {
        if (!responseTime) return 0;
        const match = responseTime.match(/(\d+)/);
        return match ? (parseInt(match[1]) > 5000 ? 5000 : parseInt(match[1])) : 0;
    }

    function aggregateData(checks, intervalMinutes) {
        if (!checks || checks.length === 0) return [];

        const grouped = new Map();

        checks.forEach(check => {
            if (!check.checkedAt) return;
            const date = new Date(check.checkedAt);
            const key = Math.floor(date.getTime() / (intervalMinutes * 60000));

            if (!grouped.has(key)) {
                grouped.set(key, {
                    totalTime: 0,
                    count: 0,
                    isUp: true,
                    date: date
                });
            }

            const group = grouped.get(key);
            const timeValue = extractResponseTime(check.responseTime);
            if (timeValue > 0) {
                group.totalTime += timeValue;
                group.count++;
            }
            if (!check.isUp) group.isUp = false;
        });

        return Array.from(grouped.values())
            .map(g => ({
                avgTime: g.count > 0 ? Math.round(g.totalTime / g.count) : 0,
                isUp: g.isUp,
                date: g.date
            }))
            .sort((a, b) => a.date - b.date);
    }

    function createChart(canvasId, data, colors) {
        const ctx = document.getElementById(canvasId)?.getContext('2d');
        if (!ctx) return null;

        // Destroy existing chart if any
        if (charts[canvasId]) {
            charts[canvasId].destroy();
        }

        charts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(() => ''),
                datasets: [{
                    data: data,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: colors,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                scales: { x: { display: false }, y: { display: false, beginAtZero: true, max: 5000 } },
                elements: { line: { borderWidth: 1 } }
            }
        });

        return charts[canvasId];
    }

    function updateHistoryList(history) {
        const historyList = document.getElementById('historyList');
        const historyCount = document.getElementById('historyCount');
        if (!historyList) return;

        let html = '';
        for (let i = 0; i < Math.min(10, history.length); i++) {
            const check = history[i];
            const statusClass = check.isUp ? 'up' : 'down';
            const statusText = check.isUp ? 'UP' : 'DOWN';
            const statusColor = check.isUp ? 'bg-success' : 'bg-danger';
            const time = check.checkedAt ? new Date(check.checkedAt).toLocaleTimeString() : 'Unknown';

            html += `
                <div class="list-group-item history-item d-flex justify-content-between align-items-center ${statusClass}">
                    <div class="d-flex align-items-center">
                        <span class="status-indicator ${statusColor}"></span>
                        <div>
                            <strong>${statusText}</strong>
                            <span class="text-muted mx-2">·</span>
                            <span class="text-muted">${check.statusCode}</span>
                            <span class="text-muted mx-2">·</span>
                            <span>${check.responseTime || '0ms'}</span>
                        </div>
                    </div>
                    <div>
                        <small class="text-muted">${time}</small>
                        ${check.errorMessage ? `<span class="badge bg-danger ms-2" title="${check.errorMessage}"><i class="bi bi-exclamation-triangle"></i></span>` : ''}
                    </div>
                </div>
            `;
        }

        historyList.innerHTML = html;
        if (historyCount) {
            historyCount.textContent = `Showing ${Math.min(10, history.length)} of ${history.length} total checks`;
        }
    }

    function updateStatsCards(stats) {
        if (!stats) return;

        const successRateEl = document.querySelector('.uptime-card:first-child .uptime-value');
        const avgResponseEl = document.querySelector('.uptime-card:nth-child(2) .uptime-value');
        const lastStatusEl = document.querySelector('.uptime-card:nth-child(3) .uptime-value');
        const lastTimeEl = document.querySelector('.uptime-card:nth-child(3) .text-muted span');
        const totalChecksEl = document.querySelector('.uptime-card:nth-child(4) .uptime-value');
        const lastChecksSpan = document.querySelector('.uptime-card:first-child .text-success span');

        if (successRateEl) successRateEl.textContent = stats.successRate + '%';
        if (avgResponseEl) avgResponseEl.textContent = stats.avgResponseTime;
        if (lastStatusEl) {
            lastStatusEl.textContent = stats.lastStatus;
            lastStatusEl.className = `uptime-value ${stats.lastStatus === 'UP' ? 'text-success' : 'text-danger'}`;
        }
        if (lastTimeEl) lastTimeEl.textContent = stats.lastTime;
        if (totalChecksEl) totalChecksEl.textContent = stats.totalChecks;
        if (lastChecksSpan) lastChecksSpan.textContent = stats.totalChecks;
    }

    function updateAllCharts(history) {
        if (!history || history.length === 0) return;

        // 1. Recent 10 checks
        const recent10 = history.slice(0, 10).reverse();
        const recentData = recent10.map(c => extractResponseTime(c.responseTime));
        const recentColors = recent10.map(c => c.isUp ? '#198754' : '#dc3545');
        createChart('chartRecent', recentData, recentColors);

        // 2. Last Hour (60 min)
        const hourChecks = history.filter(c => {
            const date = new Date(c.checkedAt);
            return date >= new Date(Date.now() - 60 * 60000);
        }).slice(0, 20).reverse();
        if (hourChecks.length > 0) {
            createChart('chartHour',
                hourChecks.map(c => extractResponseTime(c.responseTime)),
                hourChecks.map(c => c.isUp ? '#198754' : '#dc3545')
            );
        }

        // 3. Last 24 Hours
        const dayChecks = history.filter(c => {
            const date = new Date(c.checkedAt);
            return date >= new Date(Date.now() - 24 * 60 * 60000);
        }).slice(0, 30).reverse();
        if (dayChecks.length > 0) {
            createChart('chartDay',
                dayChecks.map(c => extractResponseTime(c.responseTime)),
                dayChecks.map(c => c.isUp ? '#198754' : '#dc3545')
            );
        }

        // 4. Last Week
        const weekChecks = history.filter(c => {
            const date = new Date(c.checkedAt);
            return date >= new Date(Date.now() - 7 * 24 * 60 * 60000);
        });
        if (weekChecks.length > 0) {
            const weekAgg = aggregateData(weekChecks, 60);
            if (weekAgg.length > 0) {
                createChart('chartWeek',
                    weekAgg.map(g => g.avgTime),
                    weekAgg.map(g => g.isUp ? '#198754' : '#dc3545')
                );
            }
        }

        // 5. Last Month
        const monthChecks = history.filter(c => {
            const date = new Date(c.checkedAt);
            return date >= new Date(Date.now() - 30 * 24 * 60 * 60000);
        });
        if (monthChecks.length > 0) {
            const monthAgg = aggregateData(monthChecks, 360);
            if (monthAgg.length > 0) {
                createChart('chartMonth',
                    monthAgg.map(g => g.avgTime),
                    monthAgg.map(g => g.isUp ? '#198754' : '#dc3545')
                );
            }
        }

        // 6. Last Year
        const yearChecks = history.filter(c => {
            const date = new Date(c.checkedAt);
            return date >= new Date(Date.now() - 365 * 24 * 60 * 60000);
        });
        if (yearChecks.length > 0) {
            const yearAgg = aggregateData(yearChecks, 1440);
            if (yearAgg.length > 0) {
                createChart('chartYear',
                    yearAgg.map(g => g.avgTime),
                    yearAgg.map(g => g.isUp ? '#198754' : '#dc3545')
                );
            }
        }
    }

    function refreshData() {
        const refreshSpinner = document.getElementById('refreshSpinner');
        const refreshStatus = document.getElementById('refreshStatus');

        refreshSpinner.style.display = 'inline-block';
        refreshStatus.textContent = 'Refreshing...';

        fetch(`/app/${appId}/history`)
            .then(response => response.json())
            .then(data => {
                if (data.history && data.history.length > 0) {
                    updateAllCharts(data.history);
                    updateHistoryList(data.history);
                }
                if (data.stats) {
                    updateStatsCards(data.stats);
                }

                refreshSpinner.style.display = 'none';
                refreshStatus.textContent = 'Updated';
                setTimeout(() => {
                    refreshStatus.textContent = 'Auto-refresh active';
                }, 2000);
            })
            .catch(error => {
                console.error('Refresh error:', error);
                refreshSpinner.style.display = 'none';
                refreshStatus.textContent = 'Error';
                setTimeout(() => {
                    refreshStatus.textContent = 'Auto-refresh active';
                }, 2000);
            });
    }

    // Initial load avec les données du template
    document.addEventListener('DOMContentLoaded', function() {
        const stats = /*[[${stats}]]*/ null;
        const history = /*[[${history}]]*/ [];

        if (stats && history && history.length > 0) {
            updateAllCharts(history);
            updateHistoryList(history);
        }

        // Start auto-refresh every 10 seconds
        setInterval(refreshData, 10000);
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>