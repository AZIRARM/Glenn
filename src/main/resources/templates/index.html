<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glenn - Health Monitor Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .status-success { color: #198754; }
        .status-danger { color: #dc3545; }
        .card {
            transition: all 0.3s;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .refresh-spinner { display: none; }
        .refreshing .refresh-spinner { display: inline-block; }
        .refresh-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .stat-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .app-card {
            border-left: 4px solid transparent;
        }
        .app-card.up {
            border-left-color: #198754;
        }
        .app-card.down {
            border-left-color: #dc3545;
        }
        .badge-filter {
            cursor: pointer;
            transition: all 0.2s;
        }
        .badge-filter:hover {
            transform: scale(1.05);
        }
        .badge-filter.active {
            background-color: #0d6efd !important;
            color: white !important;
        }
        .category-badge {
            cursor: pointer;
            transition: all 0.2s;
        }
        .category-badge:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        .category-badge.active-filter {
            background-color: #0d6efd !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(13,110,253,0.3);
        }
        .filter-indicator {
            display: none;
            margin-bottom: 15px;
        }
        .filter-indicator.active {
            display: block;
        }
        .btn-all-categories {
            margin-right: 10px;
        }
        .footer-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .left-buttons {
            display: flex;
            gap: 5px;
        }
        .right-buttons {
            display: flex;
            gap: 5px;
        }
        .card-footer {
            padding: 0.75rem 1rem;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">
            <i class="bi bi-shield-check"></i>
            Glenn - Health Monitor
            <small class="ms-2 fs-6 text-white-50">
                <i class="bi bi-heart-pulse"></i>
                Your applications in good health
            </small>
        </span>
        <div>
            <!-- AJOUT DE L'ICONE D'AGRANDISSEMENT POUR LA VUE SUPERVISION -->
            <a href="/supervision" class="btn btn-outline-light btn-sm me-2" title="Supervision View (Full screen mode)">
                <i class="bi bi-arrows-fullscreen"></i> Supervision
            </a>
            <span class="text-white-50">
                <i class="bi bi-clock"></i>
                <span id="lastUpdate" th:text="${currentTime}"></span>
            </span>
        </div>
    </div>
</nav>
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Total Apps</h6>
                        <h2 class="mb-0" id="totalApps" th:text="${#lists.size(apps)}">0</h2>
                    </div>
                    <i class="bi bi-grid-3x3-gap-fill fs-1 text-primary opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Healthy</h6>
                        <h2 class="mb-0 text-success" id="onlineCount">0</h2>
                    </div>
                    <i class="bi bi-check-circle-fill fs-1 text-success opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Unhealthy</h6>
                        <h2 class="mb-0 text-danger" id="offlineCount">0</h2>
                    </div>
                    <i class="bi bi-exclamation-triangle-fill fs-1 text-danger opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Global Uptime</h6>
                        <h2 class="mb-0 text-info" id="globalUptime">98.5%</h2>
                    </div>
                    <i class="bi bi-graph-up-arrow fs-1 text-info opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicateur de filtre actif -->
    <div class="filter-indicator alert alert-info d-flex justify-content-between align-items-center" id="filterIndicator">
        <div>
            <i class="bi bi-funnel-fill"></i>
            Filtering by category: <strong id="activeCategory">All</strong>
        </div>
        <div>
            <button class="btn btn-sm btn-outline-primary" onclick="showAllCategories()">
                <i class="bi bi-x-circle"></i> Clear filter
            </button>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col d-flex align-items-center">
            <button class="btn btn-outline-primary me-2 btn-all-categories" onclick="showAllCategories()">
                <i class="bi bi-grid"></i> All Categories
            </button>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-primary badge-filter active" onclick="filterAll()">
                    <i class="bi bi-list-ul"></i> All
                </button>
                <button class="btn btn-outline-success badge-filter" onclick="filterUp()">
                    <i class="bi bi-check-circle"></i> Healthy
                </button>
                <button class="btn btn-outline-danger badge-filter" onclick="filterDown()">
                    <i class="bi bi-exclamation-triangle"></i> Unhealthy
                </button>
            </div>
        </div>
        <div class="col text-end">
            <a href="/app/add" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i>
                Add Application
            </a>
            <button class="btn btn-outline-secondary" onclick="refreshData()">
                <i class="bi bi-arrow-repeat refresh-spinner"></i>
                <i class="bi bi-arrow-repeat"></i>
                Refresh
            </button>
        </div>
    </div>

    <!-- Compteur de résultats -->
    <div class="row mb-2" th:if="${not #lists.isEmpty(apps)}">
        <div class="col">
            <small class="text-muted" id="resultCount">
                Showing <span id="visibleCount">0</span> of <span id="totalCount" th:text="${#lists.size(apps)}">0</span> applications
            </small>
        </div>
    </div>

    <div class="row" id="apps-container">
        <div th:each="app : ${apps}" class="col-xl-4 col-md-6 mb-4 app-item"
             th:data-status="${latestStatuses.get(app.id) != null && latestStatuses.get(app.id).isUp ? 'up' : 'down'}"
             th:data-category="${app.category ?: 'Uncategorized'}"
             th:data-app-id="${app.id}">

            <div class="card h-100 app-card"
                 th:classappend="${latestStatuses.get(app.id) != null && latestStatuses.get(app.id).isUp ? 'up' : 'down'}">

                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-truncate" th:text="${app.name}" style="max-width: 150px;">App Name</h5>

                    <span th:id="'status-badge-' + ${app.id}"
                          th:class="|badge ${latestStatuses.get(app.id) != null && latestStatuses.get(app.id).isUp ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'}|">
                        <i th:id="'status-icon-' + ${app.id}"
                           th:class="|bi ${latestStatuses.get(app.id) != null && latestStatuses.get(app.id).isUp ? 'bi-check-circle' : 'bi-exclamation-triangle'} me-1|"></i>
                        <span th:id="'status-text-' + ${app.id}"
                              th:text="${latestStatuses.get(app.id) != null && latestStatuses.get(app.id).isUp ? 'Healthy' : 'Unhealthy'}">Status</span>
                    </span>
                </div>

                <div class="card-body">
                    <!-- Le badge de catégorie est cliquable -->
                    <p class="text-muted small mb-2">
                        <i class="bi bi-tag"></i>
                        <span class="badge bg-secondary category-badge"
                              th:text="${app.category ?: 'Uncategorized'}"
                              th:data-category="${app.category ?: 'Uncategorized'}"
                              onclick="filterByCategory(this.getAttribute('data-category'))"
                              style="cursor: pointer; font-size: 0.9rem;">
                        </span>
                    </p>

                    <p class="card-text small text-muted mb-3" th:text="${app.description ?: 'No description provided'}">
                        Description
                    </p>

                    <div class="mb-3">
                        <small class="text-muted d-block">URL:</small>
                        <a th:href="${app.url}" target="_blank" class="text-decoration-none small text-truncate d-block"
                           th:text="${app.url}">https://example.com</a>
                    </div>

                    <div class="row text-center mt-3 g-2">
                        <div class="col-4">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted d-block">HTTP Code</small>
                                <strong th:text="${latestStatuses.get(app.id)?.statusCode ?: '---'}">200</strong>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted d-block">Response</small>
                                <strong th:text="${latestStatuses.get(app.id)?.responseTime ?: '0ms'}">120ms</strong>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted d-block">Last Check</small>
                                <strong>
                                    <span th:text="${latestStatuses.get(app.id) != null ? #temporals.format(latestStatuses.get(app.id).checkedAt, 'HH:mm:ss') : '---'}">12:00:00</span>
                                </strong>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted d-block mb-1">Accepted statuses:</small>
                        <div>
                            <span th:each="status : ${app.acceptedStatusesList}"
                                  class="badge bg-secondary me-1"
                                  th:text="${status}">200</span>
                        </div>
                    </div>

                    <div th:if="${latestStatuses.get(app.id) != null && latestStatuses.get(app.id).errorMessage != null}"
                         class="mt-3 alert alert-danger py-2 small">
                        <i class="bi bi-exclamation-circle"></i>
                        <span th:text="${latestStatuses.get(app.id).errorMessage}">Error</span>
                    </div>
                </div>

                <div class="card-footer bg-transparent">
                    <div class="footer-buttons">
                        <div class="left-buttons">
                            <!-- Le crayon est maintenant à côté de Details -->
                            <a th:href="@{/app/{id}(id=${app.id})}" class="btn btn-sm btn-outline-info">
                                <i class="bi bi-graph-up"></i> Details
                            </a>
                            <a th:href="@{/app/edit/{id}(id=${app.id})}" class="btn btn-sm btn-outline-primary" title="Edit application">
                                <i class="bi bi-pencil"></i>
                            </a>
                        </div>
                        <div class="right-buttons">
                            <form th:action="@{/app/{id}/toggle(id=${app.id})}" method="post" style="display: inline;">
                                <button type="submit" class="btn btn-sm"
                                        th:classappend="${app.active} ? 'btn-outline-warning' : 'btn-outline-success'">
                                    <i th:class="${app.active} ? 'bi-pause-circle' : 'bi-play-circle'"></i>
                                    <span th:text="${app.active} ? 'Pause' : 'Resume'"></span>
                                </button>
                            </form>
                            <button class="btn btn-sm btn-outline-danger"
                                    th:onclick="deleteApp([[${app.id}]], [[${app.name}]])">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message quand aucune application -->
        <div th:if="${#lists.isEmpty(apps)}" class="col-12">
            <div class="text-center text-muted py-5">
                <i class="bi bi-inbox" style="font-size: 4rem;"></i>
                <h4 class="mt-3">No applications yet</h4>
                <p>Add your first application to start monitoring</p>
                <a href="/app/add" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Application
                </a>
            </div>
        </div>

        <!-- Message quand aucun résultat après filtrage -->
        <div th:if="${not #lists.isEmpty(apps)}" class="col-12" id="noResultsMessage" style="display: none;">
            <div class="text-center text-muted py-5">
                <i class="bi bi-search" style="font-size: 4rem;"></i>
                <h4 class="mt-3">No applications match your filters</h4>
                <p>Try adjusting your filter criteria</p>
                <button class="btn btn-primary" onclick="clearAllFilters()">
                    <i class="bi bi-eraser"></i> Clear all filters
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // État des filtres
    let currentStatusFilter = 'all';
    let currentCategoryFilter = 'all';

    // EventSource pour les mises à jour en direct
    const eventSource = new EventSource('/api/live-status');

    eventSource.onmessage = function(event) {
        const status = JSON.parse(event.data);
        updateAppStatus(status);
        updateLastUpdateTime();
    };

    function updateAppStatus(status) {
        const appItem = document.querySelector(`.app-item[data-app-id="${status.appId}"]`);
        if (!appItem) return;

        const appCard = appItem.querySelector('.app-card');
        appCard.classList.remove('up', 'down');
        appCard.classList.add(status.isUp ? 'up' : 'down');

        // Update status badge & text
        const badge = document.getElementById(`status-badge-${status.appId}`);
        const icon = document.getElementById(`status-icon-${status.appId}`);
        const text = document.getElementById(`status-text-${status.appId}`);

        if(badge) {
            badge.className = `badge ${status.isUp ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'}`;
        }
        if(icon) {
            icon.className = `bi ${status.isUp ? 'bi-check-circle' : 'bi-exclamation-triangle'} me-1`;
        }
        if(text) {
            text.textContent = status.isUp ? 'Healthy' : 'Unhealthy';
        }

        // Update metrics
        const metrics = appCard.querySelectorAll('strong');
        if(metrics.length >= 3) {
            metrics[0].textContent = status.statusCode;
            metrics[1].textContent = status.responseTime + 'ms';
            metrics[2].textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        appItem.setAttribute('data-status', status.isUp ? 'up' : 'down');
        updateStats();
        applyFilters();
    }

    function filterByCategory(category) {
        currentCategoryFilter = category;

        // Mettre à jour l'indicateur visuel
        document.getElementById('activeCategory').textContent = category;
        document.getElementById('filterIndicator').classList.add('active');

        // Enlever la classe active-filter de tous les badges
        document.querySelectorAll('.category-badge').forEach(badge => {
            badge.classList.remove('active-filter');
        });

        // Ajouter la classe active-filter aux badges de cette catégorie
        document.querySelectorAll(`.category-badge[data-category="${category}"]`).forEach(badge => {
            badge.classList.add('active-filter');
        });

        applyFilters();
    }

    function showAllCategories() {
        currentCategoryFilter = 'all';

        // Cacher l'indicateur
        document.getElementById('filterIndicator').classList.remove('active');

        // Enlever la classe active-filter de tous les badges
        document.querySelectorAll('.category-badge').forEach(badge => {
            badge.classList.remove('active-filter');
        });

        applyFilters();
    }

    function filterUp() {
        currentStatusFilter = 'up';
        document.querySelectorAll('.badge-filter').forEach(btn => {
            btn.classList.remove('active');
        });
        // Trouver et activer le bouton Healthy
        document.querySelectorAll('.badge-filter').forEach(btn => {
            if(btn.textContent.includes('Healthy')) {
                btn.classList.add('active');
            }
        });
        applyFilters();
    }

    function filterDown() {
        currentStatusFilter = 'down';
        document.querySelectorAll('.badge-filter').forEach(btn => {
            btn.classList.remove('active');
        });
        // Trouver et activer le bouton Unhealthy
        document.querySelectorAll('.badge-filter').forEach(btn => {
            if(btn.textContent.includes('Unhealthy')) {
                btn.classList.add('active');
            }
        });
        applyFilters();
    }

    function filterAll() {
        currentStatusFilter = 'all';
        document.querySelectorAll('.badge-filter').forEach(btn => {
            btn.classList.remove('active');
        });
        // Trouver et activer le bouton All
        document.querySelectorAll('.badge-filter').forEach(btn => {
            if(btn.textContent.includes('All')) {
                btn.classList.add('active');
            }
        });
        applyFilters();
    }

    function applyFilters() {
        const appItems = document.querySelectorAll('.app-item');
        let visibleCount = 0;

        appItems.forEach(item => {
            const status = item.getAttribute('data-status');
            const category = item.getAttribute('data-category');

            let statusMatch = currentStatusFilter === 'all' || status === currentStatusFilter;
            let categoryMatch = currentCategoryFilter === 'all' || category === currentCategoryFilter;

            if (statusMatch && categoryMatch) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });

        // Mettre à jour le compteur si des apps existent
        if (appItems.length > 0) {
            document.getElementById('visibleCount').textContent = visibleCount;

            // Afficher/masquer le message "aucun résultat"
            const noResultsMsg = document.getElementById('noResultsMessage');
            if (visibleCount === 0) {
                noResultsMsg.style.display = 'block';
            } else {
                noResultsMsg.style.display = 'none';
            }
        }
    }

    function clearAllFilters() {
        currentStatusFilter = 'all';
        currentCategoryFilter = 'all';

        // Reset status buttons
        document.querySelectorAll('.badge-filter').forEach(btn => {
            btn.classList.remove('active');
        });
        // Activer le bouton All
        document.querySelectorAll('.badge-filter').forEach(btn => {
            if(btn.textContent.includes('All')) {
                btn.classList.add('active');
            }
        });

        // Reset category filter
        showAllCategories();

        applyFilters();
    }

    function updateStats() {
        const appItems = document.querySelectorAll('.app-item');
        if (appItems.length === 0) return;

        const upCount = document.querySelectorAll('[data-status="up"]').length;
        const downCount = document.querySelectorAll('[data-status="down"]').length;
        const total = upCount + downCount;

        document.getElementById('onlineCount').textContent = upCount;
        document.getElementById('offlineCount').textContent = downCount;
        document.getElementById('totalApps').textContent = total;

        const uptime = total > 0 ? ((upCount / total) * 100).toFixed(1) : 0;
        document.getElementById('globalUptime').textContent = uptime + '%';

        // Mettre à jour le compteur total
        document.getElementById('totalCount').textContent = total;
    }

    function updateLastUpdateTime() {
        const now = new Date();
        document.getElementById('lastUpdate').textContent = now.toLocaleString();
    }

    function refreshData() {
        location.reload();
    }

    function deleteApp(id, name) {
        if (confirm(`Are you sure you want to delete "${name}"?`)) {
            fetch(`/app/${id}/delete`, { method: 'POST' })
                .then(() => location.reload());
        }
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        updateStats();
        applyFilters();
    });

    window.addEventListener('beforeunload', () => eventSource.close());
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>